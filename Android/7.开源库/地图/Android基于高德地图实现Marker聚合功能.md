&emsp;&emsp;ç›®å‰,ç½‘ä¸Šæä¾›åŸºäºé«˜å¾·markerèšåˆçš„æ€è·¯å¤§è‡´å·®ä¸å¤š,å¤„äºé›å½¢é˜¶æ®µã€‚é«˜å¾·å®˜æ–¹ä¹Ÿæä¾›äº†å…³äºèšåˆçš„è§£å†³æ–¹æ¡ˆ,å¯¹äºç¼“å­˜å’ŒåŠ è½½æ•ˆç‡éƒ½åšäº†ä¸€äº›å¤„ç†,ä¸ºæˆ‘ä»¬åé¢çš„å®šåˆ¶å¥ å®šäº†åŸºç¡€,æœ¬æ–‡å°±åœ¨é«˜å¾·å®˜æ–¹æä¾›çš„æ–¹æ¡ˆåŸºç¡€ä¸Šåšä¸€äº›å®šåˆ¶åŒ–ã€‚ç¬”è€…ç»è¿‡æ€è€ƒå,è¿˜æ˜¯è§‰å¾—å°†ç¯‡å¹…åˆ†ä¸ºä¸Šä¸‹ä¸¤éƒ¨åˆ†,å‰ç¯‡ä¸»è¦æ¶‰åŠèšåˆçš„åŸºæœ¬ä½¿ç”¨ä»¥åŠé’ˆå¯¹å®šåˆ¶è¿‡ç¨‹ä¸­å‡ºç°çš„å‘è¿›è¡Œå¡«è¡¥(å¦‚å¤šç§èšåˆæ ‡ç­¾çš„å†²çª,èšåˆæ ‡ç­¾ä¸æ™®é€šæ ‡ç­¾çš„å†²çªé—®é¢˜ç­‰),ä¸‹ç¯‡åˆ™è®²è¿°å¦‚ä½•å®šåˆ¶åŒ–markerå¹¶åŠ è½½ç½‘ç»œå›¾ç‰‡(ä¸ºäº†æ–¹ä¾¿æè¿°,markerèšåˆåœ¨ä¸‹æ–‡éƒ½ç§°ä¹‹ä¸ºèšåˆæ ‡ç­¾)ã€‚çœ‹å®Œä¸¤ç¯‡æ–‡ç« ,å¤§å®¶è¿˜å¯ä»¥å°è¯•å°†èšåˆå’Œç½‘ç»œå›¾ç‰‡æ ·å¼çš„markerç»“åˆèµ·æ¥,è¾¾åˆ°æ›´åŠ ç‚«é…·çš„æ•ˆæœã€‚
è¯ä¸å¤šè¯´,å…ˆæ¥çœ‹çœ‹æœ€ç»ˆçš„æ•ˆæœå§:

![æ•ˆæœå›¾](http://ovl7kcyr4.bkt.clouddn.com/18-5-6/19951549.jpg)


&emsp;&emsp;å…ˆæ¥æ”¾ä¸€ä¸‹å®˜ç½‘æä¾›çš„èšåˆç‚¹çš„demo:https://github.com/amap-demo/android-cluster-marker
,å¦‚æœåªæ˜¯å®ç°ä¸€ç§èšåˆç‚¹,å¯ä»¥å¤åˆ¶å®˜æ–¹çš„demoä»£ç ,ç¨å¾®æ”¹æ”¹å°±å¯ä»¥ç”¨äº†ã€‚å¦‚æœä½ ä»¬äº§å“æœ‰å…¶ä»–éœ€æ±‚,æ¯”å¦‚å¤šç§èšåˆæ ‡ç­¾ç‚¹,æˆ–è€…å®ç°æ™®é€šæ ‡ç­¾å’Œèšåˆæ ‡ç­¾çš„æ··æ’ä½¿ç”¨,é‚£ä¹ˆå¯ä»¥å‚è€ƒä¸‹æœ¬æ–‡æä¾›çš„æ”¹è¿›æ€è·¯ã€‚

- å‘ç°é—®é¢˜:

é¦–å…ˆ,æˆ‘ä»¬å‘ç°é«˜å¾·å®˜æ–¹æä¾›çš„demoå­˜åœ¨çš„é—®é¢˜:
1. å½“å­˜åœ¨å¤šç§ç±»å‹èšåˆæ ‡ç­¾ç‚¹æ—¶,èšåˆç‚¹çš„ç‚¹å‡»äº‹ä»¶å†²çªé—®é¢˜.
>è¿™ä¸ªé—®é¢˜æ˜¯ä»€ä¹ˆæ„æ€å‘¢?ä¸¾ä¸ªä¾‹å­:å½“åœ°å›¾ä¸Šæˆ‘ä»¬å…ˆååˆå§‹åŒ–ä¸¤ç§èšåˆæ ‡ç­¾ç‚¹Aå’ŒBçš„æ—¶å€™,ä¸ç®¡ç‚¹å‡»Aè¿˜æ˜¯Bç±»å‹çš„èšåˆç‚¹,éƒ½ä¼šåªå“åº”Bç±»çš„ç‚¹å‡»äº‹ä»¶,å³å…ˆå£°æ˜çš„èšåˆæ ‡ç­¾çš„ç‚¹å‡»äº‹ä»¶ä¼šè¢«åå£°æ˜çš„èšåˆæ ‡ç­¾çš„ç‚¹å‡»äº‹ä»¶"æŠ¢å ".
2. å½“åœ°å›¾ä¸Šå­˜åœ¨æ™®é€šæ ‡ç­¾(Marker)å’Œèšåˆæ ‡ç­¾(Cluster)æ—¶,åŒæ ·ä¼šäº§ç”Ÿç‚¹å‡»äº‹ä»¶çš„å†²çªé—®é¢˜.
>è¿™ä¸ªæ„æ€å°±æ˜¯,ç‚¹å‡»èšåˆæ ‡ç­¾ä»ç„¶ä¼šå“åº”æ™®é€šæ ‡ç­¾çš„ç‚¹å‡»äº‹ä»¶.

- åˆ†æé—®é¢˜:
>è¿™ä¸¤ä¸ªé—®é¢˜å…¶å®å½’æ ¹ç»“åº•æ˜¯ä¸€ä¸ªé—®é¢˜,éƒ½æ˜¯å› ä¸ºmarkerçš„ç‚¹å‡»äº‹ä»¶è¢«æŠ¢å ,ä»å®˜æ–¹çš„æä¾›çš„ClusterOverlayç±»ä¸­ä»£ç æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºæ¥:
```
......
amap.setOnCameraChangeListener(this);
amap.setOnMarkerClickListener(this);
......
 //ç‚¹å‡»äº‹ä»¶
    @Override
    public boolean onMarkerClick(Marker arg0) {
        if (mClusterClickListener == null) {
            return true;
        }
       Cluster cluster= (Cluster) arg0.getObject();
        if(cluster!=null){
            mClusterClickListener.onClick(arg0,cluster.getClusterItems());
            return true;
        }
        return false;
    }

```
&emsp;&emsp;ä»ä»¥ä¸Šä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥,èšåˆå¤„ç†ç±»ClusterOverlayå®ç°äº†AMap.OnMarkerClickListeneræ¥å£,è€Œå½“æˆ‘ä»¬ä½¿ç”¨ä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šæ ·å¼çš„èšåˆæ ‡ç­¾æ—¶,æˆ‘ä»¬å°±ä¼šå‘ç°æ˜æ˜æ˜¯ä¸¤ç§ç±»å‹çš„èšåˆæ ‡ç­¾,ä½†æ˜¯å´è§¦å‘ç›¸åŒçš„ç‚¹å‡»äº‹ä»¶ã€‚è¿™æ ·æ˜¾ç„¶æ˜¯ä¸ç¬¦åˆæˆ‘ä»¬é¢„æœŸéœ€æ±‚çš„,é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•è®©ä¸åŒæ ·å¼çš„èšåˆæ ‡ç­¾A,B,C...å„å¸å…¶èŒå‘¢?ä½ è‚¯å®šä¼šè¯´,åºŸè¯,ä¸ç„¶ä½ ç°åœ¨åœ¨è®²å•¥!å’³å’³,è¯·å…è®¸æˆ‘é™é™~ 

- è§£å†³é—®é¢˜:

&emsp;&emsp;æ˜¾ç„¶,å¦‚æœæˆ‘ä»¬æƒ³è®©å„ç§èšåˆæ ‡ç­¾äº’ä¸å¹²æ‰°,éœ€è¦é›†ä¸­ç®¡ç†å®ƒä»¬çš„ç‚¹å‡»äº‹ä»¶,å³OnMarkerClickListenerã€‚å‡è®¾æˆ‘ä»¬å†™äº†ä¸¤ä¸ªä¸åŒçš„èšåˆæ ‡ç­¾ç±»ClusterOverlayAå’ŒClusterOverlayB,æˆ‘ä»¬å¯ä»¥å°†ä¸¤ä¸ªç±»ä¸­OnMarkerClick()æ–¹æ³•ä¸­çš„é€»è¾‘æ‹¿å‡ºæ¥,å•ç‹¬å°è£…æˆä¸€ä¸ªæ–¹æ³•,ç„¶åæ”¾åœ¨æˆ‘ä»¬Activityçš„onMarkerClick()ä¸­æ‰§è¡Œ.è¿™é‡Œæˆ‘è´´ä¸€ä¸‹ä¿®æ”¹åçš„ClusterOverlayç±»,å‰æ–¹é«˜èƒ½,ä¸€å¤§æ³¢ä»£ç æ¥è¢­:
>ClusterOverlay:
```
/**
 * Created by yiyi.qi on 16/10/10.
 * æ•´ä½“è®¾è®¡é‡‡ç”¨äº†ä¸¤ä¸ªçº¿ç¨‹,ä¸€ä¸ªçº¿ç¨‹ç”¨äºè®¡ç®—ç»„ç»‡èšåˆæ•°æ®,ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£å¤„ç†Markerç›¸å…³æ“ä½œ
 */
public class ClusterOverlay {
    private AMap mAMap;
    private Context mContext;
    private List<ClusterItem> mClusterItems;
    private List<Cluster> mClusters;
    private int mClusterSize;
    private ClusterClickListener mClusterClickListener;
    private ClusterRender mClusterRender;
    private ClusterRenderB bClusterRender;
    private AMap.OnMarkerClickListener markerClickListener=new AMap.OnMarkerClickListener() {
        @Override
        public boolean onMarkerClick(Marker arg0) {
            if (mClusterClickListener == null) {
                return true;
            }
            Cluster cluster = (Cluster) arg0.getObject();
            //å°†markerçš„ä½ç½®ç§»åŠ¨åˆ°åœ°å›¾ä¸­å¿ƒ
            LatLng latLng=new LatLng(arg0.getPosition().latitude,arg0.getPosition().longitude);
            mAMap.moveCamera(CameraUpdateFactory.changeLatLng(latLng));
            if (cluster != null) {
                arg0.showInfoWindow();
                Log.e("timeory", "æ™®é€šæ ‡ç­¾infowindowå‡ºç°äº†å—?  " +  arg0.isInfoWindowShown()+ "   "+ arg0.isInfoWindowEnable(), null);
                mClusterClickListener.onClick(arg0, cluster.getClusterItems());
                return true;
            }

            return false;
        }
    };




    private List<Marker> mAddMarkers = new ArrayList<Marker>();
    private double mClusterDistance;
    private LruCache<Integer, BitmapDescriptor> mLruCache;
    private HandlerThread mMarkerHandlerThread = new HandlerThread("addMarker");
    private HandlerThread mSignClusterThread = new HandlerThread("calculateCluster");
    private Handler mMarkerhandler;
    private Handler mSignClusterHandler;
    private float mPXInMeters;
    private boolean mIsCanceled = false;
    private MarkerOptions markerOptions;
    private Cluster mcluster;
    private LatLng latlng1;

    /**
     * æ„é€ å‡½æ•°
     *
     * @param amap
     * @param clusterSize èšåˆèŒƒå›´çš„å¤§å°ï¼ˆæŒ‡ç‚¹åƒç´ å•ä½è·ç¦»å†…çš„ç‚¹ä¼šèšåˆåˆ°ä¸€ä¸ªç‚¹æ˜¾ç¤ºï¼‰
     * @param context
     */
    public ClusterOverlay(AMap amap, int clusterSize, Context context) {
        this(amap, null, clusterSize, context);


    }

    /**
     * æ„é€ å‡½æ•°,æ‰¹é‡æ·»åŠ èšåˆå…ƒç´ æ—¶,è°ƒç”¨æ­¤æ„é€ å‡½æ•°
     *  é»˜è®¤æœ€å¤šä¼šç¼“å­˜80å¼ å›¾ç‰‡ä½œä¸ºèšåˆæ˜¾ç¤ºå…ƒç´ å›¾ç‰‡,æ ¹æ®è‡ªå·±æ˜¾ç¤ºéœ€æ±‚å’Œappä½¿ç”¨å†…å­˜æƒ…å†µ,å¯ä»¥ä¿®æ”¹æ•°é‡
     * @param amap
     * @param clusterItems èšåˆå…ƒç´ 
     * @param clusterSize
     * @param context
     */
    public ClusterOverlay(AMap amap, List<ClusterItem> clusterItems, int clusterSize, Context context) {
        mLruCache = new LruCache<Integer, BitmapDescriptor>(80) {
            protected void entryRemoved(boolean evicted, Integer key, BitmapDescriptor oldValue, BitmapDescriptor newValue) {
                oldValue.getBitmap().recycle();
            }
        };
        if (clusterItems != null) {
            mClusterItems = clusterItems;
        } else {
            mClusterItems = new ArrayList<ClusterItem>();
        }
        mContext = context;
        mClusters = new ArrayList<Cluster>();
        this.mAMap = amap;
        mClusterSize = clusterSize;
        mPXInMeters = mAMap.getScalePerPixel();
        mClusterDistance = mPXInMeters * mClusterSize;
        initThreadHandler();
        assignClusters();
    }

    /**
     * by moos on 2017/11/13
     * function:èšåˆåˆ·æ–°,åœ¨activityçš„onCameraChangeFinish()æ–¹æ³•ä¸­
     */
    public void updateClusters(){
        mPXInMeters = mAMap.getScalePerPixel();
        mClusterDistance = mPXInMeters * mClusterSize;
        assignClusters();
    }

    /**
     * by moos on 2017/11/13
     * func:é€šè¿‡activityä¸­çš„onMarkerClick()å“åº”èšåˆç‚¹çš„ç‚¹å‡»äº‹ä»¶
     * @param arg0
     */
    public void respondClusterClickEvent(Marker arg0){

        Cluster cluster = (Cluster) arg0.getObject();
        //å°†markerçš„ä½ç½®ç§»åŠ¨åˆ°åœ°å›¾ä¸­å¿ƒ
        LatLng latLng=new LatLng(arg0.getPosition().latitude,arg0.getPosition().longitude);
        mAMap.moveCamera(CameraUpdateFactory.changeLatLng(latLng));
        if (cluster != null) {
            arg0.showInfoWindow();
            Log.e("timeory", "æ™®é€šæ ‡ç­¾infowindowå‡ºç°äº†å—?  " +  arg0.isInfoWindowShown()+ "   "+ arg0.isInfoWindowEnable(), null);
            mClusterClickListener.onClick(arg0, cluster.getClusterItems());
        }

    }

    /**
     * è®¾ç½®èšåˆç‚¹çš„ç‚¹å‡»äº‹ä»¶
     *
     * @param clusterClickListener
     */
    public void setOnClusterClickListener(ClusterClickListener clusterClickListener) {
        mClusterClickListener = clusterClickListener;
    }

    /**
     * æ·»åŠ ä¸€ä¸ªèšåˆç‚¹
     *
     * @param item
     */
    public void addClusterItem(ClusterItem item) {
        Message message = Message.obtain();
        message.what = SignClusterHandler.CALCULATE_SINGLE_CLUSTER;
        message.obj = item;
        mSignClusterHandler.sendMessage(message);
    }

    /**
     * å…±å¤–éƒ¨è°ƒç”¨çš„æ¥å£,è®¾ç½®èšåˆå…ƒç´ çš„æ¸²æŸ“æ ·å¼ï¼Œä¸è®¾ç½®åˆ™é»˜è®¤ä¸ºæ°”æ³¡åŠ æ•°å­—å½¢å¼è¿›è¡Œæ¸²æŸ“
     *
     * @param render
     */
    public void setClusterRenderer(ClusterRender render) {
        mClusterRender = render;
    }
    /**
     * è®¾ç½®èšåˆå…ƒç´ çš„æ¸²æŸ“æ ·å¼ï¼Œä¸è®¾ç½®åˆ™é»˜è®¤ä¸ºæ°”æ³¡åŠ æ•°å­—å½¢å¼è¿›è¡Œæ¸²æŸ“
     *
     * @param render
     */
    public void setBClusterRenderer(ClusterRenderB render) {
        bClusterRender = render;
    }

    public void onDestroy() {
        mIsCanceled = true;
        mSignClusterHandler.removeCallbacksAndMessages(null);
        mMarkerhandler.removeCallbacksAndMessages(null);
        mSignClusterThread.quit();
        mMarkerHandlerThread.quit();
        for (Marker marker : mAddMarkers) {
            marker.remove();

        }
        if(markerClickListener!=null){
            markerClickListener = null;
        }
        mAddMarkers.clear();
        mLruCache.evictAll();
    }

    /**
     * æ¸…é™¤makerç‚¹å‡»äº‹ä»¶,é˜²æ­¢æŠ¢å 
     */
    public void cleanListener(){
        if(markerClickListener!=null){
            markerClickListener = null;
        }
    }

    //åˆå§‹åŒ–Handler
    private void initThreadHandler() {
        mMarkerHandlerThread.start();
        mSignClusterThread.start();
        mMarkerhandler = new MarkerHandler(mMarkerHandlerThread.getLooper());
        mSignClusterHandler = new SignClusterHandler(mSignClusterThread.getLooper());
    }



    /**
     * å°†èšåˆå…ƒç´ æ·»åŠ è‡³åœ°å›¾ä¸Š
     */
    private void addClusterToMap(List<Cluster> clusters) {

        ArrayList<Marker> removeMarkers = new ArrayList<>();
        removeMarkers.addAll(mAddMarkers);
        AlphaAnimation alphaAnimation = new AlphaAnimation(1, 0);
        MyAnimationListener myAnimationListener = new MyAnimationListener(removeMarkers);
        for (Marker marker : removeMarkers) {
            marker.setAnimation(alphaAnimation);
            marker.setAnimationListener(myAnimationListener);
            marker.startAnimation();
        }

        for (Cluster cluster : clusters) {
            addSingleClusterToMap(cluster);
        }
    }

    private AlphaAnimation mADDAnimation = new AlphaAnimation(0, 1);

    /**
     * å°†å•ä¸ªèšåˆå…ƒç´ æ·»åŠ è‡³åœ°å›¾æ˜¾ç¤º
     *
     * @param cluster
     */
    private void addSingleClusterToMap(Cluster cluster) {
        latlng1 = cluster.getCenterLatLng();
        markerOptions = new MarkerOptions();
        markerOptions
                .anchor(0.5f, 0.5f)
                .icon(getBitmapDes(cluster.getClusterCount()))
                .position(latlng1);
        Marker marker = mAMap.addMarker(markerOptions);
        marker.setAnimation(mADDAnimation);
        marker.setObject(cluster);
        marker.startAnimation();

//        marker.setTitle("ä½ å¥½å•Š");
//        marker.setSnippet("çœŸçš„ä¸å¥½");
        cluster.setMarker(marker);
        mcluster = cluster;
        mAddMarkers.add(marker);

    }

    public void newIcon() {
        markerOptions
                .anchor(0.5f, 0.5f)
                .icon(getBitmapDes(mcluster.getClusterCount()))
                .position(latlng1);
    }


    private void calculateClusters() {
        mIsCanceled = false;
        mClusters.clear();
        //åœ°å›¾è·å–è½¬æ¢å™¨, è·å–å¯è§†åŒºåŸŸ, è·å–å¯è§†åŒºåŸŸçš„å››ä¸ªç‚¹å½¢æˆçš„ç»çº¬åº¦èŒƒå›´, å¾—åˆ°ä¸€ä¸ªç»çº¬åº¦èŒƒå›´
        LatLngBounds visibleBounds = mAMap.getProjection().getVisibleRegion().latLngBounds;
        for (ClusterItem clusterItem : mClusterItems) {
            if (mIsCanceled) {
                return;
            }
            LatLng latlng = clusterItem.getPosition();//èšåˆå…ƒç´ çš„åœ°ç†ä½ç½®
            if (visibleBounds.contains(latlng)) {//å¦‚æœè¿™ä¸ªèŒƒå›´åŒ…å«è¿™ä¸ªèšåˆå…ƒç´ çš„åœ°ç†ä½ç½®
                Cluster cluster = getCluster(latlng, mClusters);//æ ¹æ®è¿™ä¸ªä½ç½®å’Œèšåˆç‰©çš„é›†åˆ, è·å¾—ä¸€ä¸ªèšåˆå™¨
                if (cluster != null) {
                    cluster.addClusterItem(clusterItem);//å¾€èšåˆå™¨ä¸­æ·»åŠ èšåˆç‚¹
                } else {
                    cluster = new Cluster(latlng);
                    mClusters.add(cluster);
                    cluster.addClusterItem(clusterItem);
                }

            }
        }

        //å¤åˆ¶ä¸€ä»½æ•°æ®ï¼Œè§„é¿åŒæ­¥
        List<Cluster> clusters = new ArrayList<Cluster>();
        clusters.addAll(mClusters);
        Message message = Message.obtain();
        message.what = MarkerHandler.ADD_CLUSTER_LIST;
        message.obj = clusters;
        if (mIsCanceled) {
            return;
        }
        mMarkerhandler.sendMessage(message);
    }

    /**
     * å¯¹ç‚¹è¿›è¡Œèšåˆ
     */
    private void assignClusters() {
        mIsCanceled = true;
        mSignClusterHandler.removeMessages(SignClusterHandler.CALCULATE_CLUSTER);
        mSignClusterHandler.sendEmptyMessage(SignClusterHandler.CALCULATE_CLUSTER);
    }

    /**
     * åœ¨å·²æœ‰çš„èšåˆåŸºç¡€ä¸Šï¼Œå¯¹æ·»åŠ çš„å•ä¸ªå…ƒç´ è¿›è¡Œèšåˆ
     *
     * @param clusterItem
     */
    private void calculateSingleCluster(ClusterItem clusterItem) {
        LatLngBounds visibleBounds = mAMap.getProjection().getVisibleRegion().latLngBounds;
        LatLng latlng = clusterItem.getPosition();
        if (!visibleBounds.contains(latlng)) {
            return;
        }
        Cluster cluster = getCluster(latlng, mClusters);
        if (cluster != null) {
            cluster.addClusterItem(clusterItem);
            Message message = Message.obtain();
            message.what = MarkerHandler.UPDATE_SINGLE_CLUSTER;

            message.obj = cluster;
            mMarkerhandler.removeMessages(MarkerHandler.UPDATE_SINGLE_CLUSTER);
            mMarkerhandler.sendMessageDelayed(message, 5);


        } else {

            cluster = new Cluster(latlng);
            mClusters.add(cluster);
            cluster.addClusterItem(clusterItem);
            Message message = Message.obtain();
            message.what = MarkerHandler.ADD_SINGLE_CLUSTER;
            message.obj = cluster;
            mMarkerhandler.sendMessage(message);

        }
    }

    /**
     * æ ¹æ®ä¸€ä¸ªç‚¹è·å–æ˜¯å¦å¯ä»¥ä¾é™„çš„èšåˆç‚¹ï¼Œæ²¡æœ‰åˆ™è¿”å›null
     *
     * @param latLng
     * @return
     */
    private Cluster getCluster(LatLng latLng, List<Cluster> clusters) {
        for (Cluster cluster : clusters) {
            LatLng clusterCenterPoint = cluster.getCenterLatLng();
            double distance = AMapUtils.calculateLineDistance(latLng, clusterCenterPoint);
            if (distance < mClusterDistance) {
                return cluster;
            }
        }

        return null;
    }


    /**
     * è·å–æ¯ä¸ªèšåˆç‚¹çš„ç»˜åˆ¶æ ·å¼
     */
    private BitmapDescriptor getBitmapDes(int num) {

        //åŠ è½½å­—ä½“
        Typeface typeFace = Typeface.createFromAsset(mContext.getAssets(), "fonts/A-OTF-ShinGoPr6N-Ultra.otf");

        BitmapDescriptor bitmapDescriptor = mLruCache.get(num);
        if (bitmapDescriptor == null) {
            TextView textView = new TextView(mContext);
            // åº”ç”¨å­—ä½“
            textView.setTypeface(typeFace);
            if (num < 10) {
                String tile = String.valueOf(num);

                textView.setText(tile);
            }else if(num==1){
                textView.setText("");
            }else {
                float zoom = mAMap.getCameraPosition().zoom;
                //loge("å½“å‰ç¼©æ”¾çº§åˆ«æ˜¯==" + zoom);
                if (zoom == 19.0 || zoom == 20.0) {
                    String tile = String.valueOf(num);
                    textView.setText(tile);
                }
            }
            textView.setGravity(Gravity.CENTER);
            textView.setTextColor(Color.parseColor("#ffffff"));
            textView.setTextSize(TypedValue.COMPLEX_UNIT_SP, 12);
            if (mClusterRender != null && mClusterRender.getDrawAble(num) != null) {
                textView.setBackgroundDrawable(mClusterRender.getDrawAble(num));   //æ ¹æ®æ•°é‡è®¾ç½®èƒŒæ™¯æ ·å¼
            } else {
                //textView.setBackgroundResource(R.mipmap.act_map_evelopetwo);
                //2017/09/25ä¿®æ”¹ æ¢å›¾æ ‡
                textView.setBackgroundResource(R.mipmap.act_map_blue_icon_bg);
            }
            bitmapDescriptor = BitmapDescriptorFactory.fromView(textView);
            mLruCache.put(num, bitmapDescriptor);    //æŠŠèšåˆç‚¹æ•°é‡,æ ·å¼é”®å€¼å¯¹å½¢å¼å­˜å…¥é›†åˆä¸­

        }
        return bitmapDescriptor;
    }

    /**
     * æ›´æ–°å·²åŠ å…¥åœ°å›¾èšåˆç‚¹çš„æ ·å¼
     */
    private void updateCluster(Cluster cluster) {

        Marker marker = cluster.getMarker();
        marker.setIcon(getBitmapDes(cluster.getClusterCount()));


    }




//-----------------------è¾…åŠ©å†…éƒ¨ç±»ç”¨---------------------------------------------

    /**
     * markeræ¸å˜åŠ¨ç”»ï¼ŒåŠ¨ç”»ç»“æŸåå°†Markeråˆ é™¤
     */
    class MyAnimationListener implements Animation.AnimationListener {
        private List<Marker> mRemoveMarkers;

        MyAnimationListener(List<Marker> removeMarkers) {
            mRemoveMarkers = removeMarkers;
        }

        @Override
        public void onAnimationStart() {

        }

        @Override
        public void onAnimationEnd() {
            for (Marker marker : mRemoveMarkers) {
                marker.remove();
            }
            mRemoveMarkers.clear();
        }
    }

    /**
     * å¤„ç†marketæ·»åŠ ï¼Œæ›´æ–°ç­‰æ“ä½œ
     */
    class MarkerHandler extends Handler {

        static final int ADD_CLUSTER_LIST = 0;

        static final int ADD_SINGLE_CLUSTER = 1;

        static final int UPDATE_SINGLE_CLUSTER = 2;

        MarkerHandler(Looper looper) {
            super(looper);
        }

        public void handleMessage(Message message) {

            switch (message.what) {
                case ADD_CLUSTER_LIST:
                    List<Cluster> clusters = (List<Cluster>) message.obj;
                    addClusterToMap(clusters);
                    break;
                case ADD_SINGLE_CLUSTER:
                    Cluster cluster = (Cluster) message.obj;
                    addSingleClusterToMap(cluster);
                    break;
                case UPDATE_SINGLE_CLUSTER:
                    Cluster updateCluster = (Cluster) message.obj;
                    updateCluster(updateCluster);
                    break;
            }
        }
    }

    /**
     * å¤„ç†èšåˆç‚¹ç®—æ³•çº¿ç¨‹
     */
    class SignClusterHandler extends Handler {
        static final int CALCULATE_CLUSTER = 0;
        static final int CALCULATE_SINGLE_CLUSTER = 1;

        SignClusterHandler(Looper looper) {
            super(looper);
        }

        public void handleMessage(Message message) {
            switch (message.what) {
                case CALCULATE_CLUSTER:
                    calculateClusters();
                    break;
                case CALCULATE_SINGLE_CLUSTER:
                    ClusterItem item = (ClusterItem) message.obj;
                    mClusterItems.add(item);
                    Log.e("cluster_overlay", "calculate single cluster");
                    calculateSingleCluster(item);
                    break;
            }
        }
    }
}
```
ä»¥ä¸Šä»£ç å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±å…·ä½“éœ€è¦ä¿®æ”¹,æ¥ä¸‹æ¥æ˜¯èšåˆæ ‡ç­¾ç±»Clusterä»£ç ,å‡ ä¹æ²¡æ”¹(æ»‘ç¨½):
>Cluster:
```
public class Cluster {


    private LatLng mLatLng;
    private List<ClusterItem> mClusterItems;
    private Marker mMarker;


    public Cluster(LatLng latLng) {

        mLatLng = latLng;
        mClusterItems = new ArrayList<ClusterItem>();
    }

    public Cluster(List<ClusterItem> clusterItems){
        mClusterItems = new ArrayList<>() ;
        mClusterItems = clusterItems;
    }

    public void addClusterItem(ClusterItem clusterItem) {
        mClusterItems.add(clusterItem);
    }

    public int getClusterCount() {
        return mClusterItems.size();
    }


    public LatLng getCenterLatLng() {
        return mLatLng;
    }

    public void setMarker(Marker marker) {
        mMarker = marker;
    }

    public Marker getMarker() {
        return mMarker;
    }

    public List<ClusterItem> getClusterItems() {
        return mClusterItems;
    }
}

```

ç„¶åå°±æ˜¯ClusterItemæ¥å£äº†,ç”¨æ¥è·å–èšåˆæ ‡ç­¾çš„ç›¸å…³ä¿¡æ¯:
>ClusterItem:
```

public interface ClusterItem {
    /**
     * è¿”å›èšåˆå…ƒç´ çš„åœ°ç†ä½ç½®
     *
     * @return
     */
    LatLng getPosition();
    String getUserType();

}
```
æœ‰äººå¯èƒ½ä¼šé—®:getUserType()æ–¹æ³•å¹²å•¥ç”¨çš„?å®¢å®˜,åˆ«æ€¥,å…ˆæ¥ç€å¾€ä¸‹çœ‹,å¾ˆå¿«å°±çŸ¥é“å®ƒçš„ç”¨å¤„äº†.

æ¥ç€,å°±æ˜¯æˆ‘ä»¬çš„RegionItemç±»äº†,å®ç°äº†ClusterItemæ¥å£:
>RegionItem:

```
public class RegionItem implements ClusterItem {
    private LatLng mLatLng;
    private String userType;



    public String getUserType() {
        return userType;
    }

    public RegionItem(LatLng latLng, String userType) {
        this.mLatLng=latLng;
        this.userType = userType;
    }

    @Override
    public LatLng getPosition() {
        // TODO Auto-generated method stub
        return mLatLng;
    }

}

```

æœ€å,å°±æ˜¯è¦åœ¨Activityä¸­æ ¹æ®éœ€æ±‚æ·»åŠ æˆ‘ä»¬çš„èšåˆæ ‡ç­¾äº†:
```
private ClusterOverlay mClusterOverlay;//æ™®é€šç”¨æˆ·èšåˆè¦†ç›–ç‰©çš„å¯¹è±¡
private BClusterOverlay bClusterOverlay;//ä¼ä¸šç”¨æˆ·èšåˆè¦†ç›–ç‰©çš„å¯¹è±¡
/**
     * by moos on 2017/11/15
     * func:æ·»åŠ å¹¶æ˜¾ç¤ºèšåˆç‚¹,å¢åŠ ç‚¹å‡»å’Œç»˜åˆ¶äº‹ä»¶
     */
    
    private void addItems() {
        new Thread() {
            public void run() {

                List<ClusterItem> items = new ArrayList<ClusterItem>();//æ™®é€šç”¨æˆ·
               
                List<ClusterItem> bItems = new ArrayList<ClusterItem>();//ä¼ä¸šç”¨æˆ·
            
                 //loge("é™„è¿‘çš„ç‚¹æœ‰===" + imageNearBean.getData().getExhibitionList().size());
                for (int i = 0; i < imageNearBean.getData().getExhibitionList().size(); i++) {

                    double lat = imageNearBean.getData().getExhibitionList().get(i).getLatitude();
                    double lon = imageNearBean.getData().getExhibitionList().get(i).getLongitude();

                    if (imageNearBean.getData().getExhibitionList().get(i).getUserType() != null &&
                            imageNearBean.getData().getExhibitionList().get(i).getUserType().equals("03")) {//æ˜¯ä¼ä¸šç”¨æˆ·çš„æ•°æ®
                        LatLng latLng = new LatLng(lat, lon, false);
                        RegionItem regionItem = new RegionItem(latLng,  imageNearBean.getData().getExhibitionList().get(i).getUserType());//æ·»åŠ å…ƒç´ 
                        bItems.add(regionItem);
                        allBussinessBean.add(imageNearBean.getData().getExhibitionList().get(i));//æ”¾å…¥æ‰€æœ‰ä¼ä¸šç”¨æˆ·æ•°æ®
                    }else { //æ˜¯æ™®é€šç”¨æˆ·
                        LatLng latLng = new LatLng(lat, lon, false);
                        RegionItem regionItem = new RegionItem(latLng, imageNearBean.getData().getExhibitionList().get(i).getOriginalId(), imageNearBean.getData().getExhibitionList().get(i).getUserType());//æ·»åŠ å…ƒç´ 
                        items.add(regionItem);
                    }

                }

                log.e("æ™®é€šç”¨æˆ·æœ‰==" + items.size());
                log.e("ä¼ä¸šç”¨æˆ·æœ‰==" + bItems.size());

                if ( items.size() > 0) {
    
                    if (mClusterOverlay == null) {
                        //è¦†ç›–ç‰©çš„é›†åˆ,
                        mClusterOverlay = new ClusterOverlay(mAMap, items, dp2px(getApplicationContext(), clusterRadius), getApplicationContext());   //åœ°å›¾å¯¹è±¡,é›†åˆ,èšåˆèŒƒå›´,ä¸Šä¸‹æ–‡ä¼ åˆ°æŒ‡å®šæ–¹æ³•å®ç°
                    } else {
                        mClusterOverlay.onDestroy();   //é”€æ¯ä¹‹å‰çš„è¦†ç›–ç‰©é›†åˆ
                        mClusterOverlay = null;
                        mClusterOverlay = new ClusterOverlay(mAMap, items, dp2px(getApplicationContext(), clusterRadius), getApplicationContext());
                    }
                    //æ¸²æŸ“å’Œèšåˆç‚¹ç‚¹å‡»äº‹ä»¶ç›‘å¬
                    mClusterOverlay.setClusterRenderer(MapActivity.this);      //getdrawable æ–¹æ³•å®ç°
                    mClusterOverlay.setOnClusterClickListener(MapActivity.this);    //onclickæ–¹æ³•å®ç°
                }
                
                if (  bItems.size() > 0) {
                    //å•†å®¶ç”¨æˆ·æ•°æ®
                    loge("è®¾ç½®ä¼ä¸šæ ‡ç­¾ç‚¹å‡»äº‹ä»¶");
                    if (bClusterOverlay == null) {
                        //è¦†ç›–ç‰©çš„é›†åˆ
                        bClusterOverlay = new BClusterOverlay(mAMap, bItems, dp2px(getApplicationContext(), clusterRadius), getApplicationContext());
                    } else {
                        bClusterOverlay.onDestroy();
                        bClusterOverlay = null;
                        bClusterOverlay = new BClusterOverlay(mAMap, bItems, dp2px(getApplicationContext(), clusterRadius), getApplicationContext());
                    }
                    //æ¸²æŸ“å’Œèšåˆç‚¹ç‚¹å‡»äº‹ä»¶ç›‘å¬
                    bClusterOverlay.setClusterRenderer(this);
                    bClusterOverlay.setOnClusterClickListener(MapActivity.this);    //onBclick æ–¹æ³•å®ç°
                }

                runOnUiThread(new Runnable() {
                    @Override
                    public void run() {
                        addMarkersToMap();//æ·»åŠ æ™®é€šmarkeråˆ°åœ°å›¾
                    }
                });

            }
        }.start();


    }

```
è¿™é‡Œå¤§å®¶å¯èƒ½çœ‹å¾—å¾ˆçƒ¦,æ²¡é”™,çœ‹å¾—å¾ˆçƒ¦å°±å¯¹äº†ğŸ˜†!å› ä¸ºè¿™ä¸€éƒ¨åˆ†å®Œå…¨æ²¡å¿…è¦çœ‹...åªæ˜¯ä¸ºäº†ç­›é€‰åå°ä¸åŒçš„ç”¨æˆ·æ•°æ®è€Œå·²ã€‚è®°å¾—ä¹‹å‰æˆ‘æåˆ°çš„ClusterItemç±»ä¸­getUserType()æ–¹æ³•ä»¥åŠå®ç°è¿™ä¸ªæ¥å£çš„ç±»RegionItemä¸­å®šä¹‰çš„userTypeå˜é‡å—?å®ƒçš„ä½œç”¨å°±æ˜¯ç”¨æ¥åŒºåˆ†ä¸åŒçš„èšåˆæ ‡ç­¾,ä»¥ä¸Šä»£ç çš„03ä»£è¡¨å•†å®¶ç”¨æˆ·,å…¶ä½™ç±»å‹é»˜è®¤æ™®é€šç”¨æˆ·ã€‚

æœ€å,å°±æ˜¯æˆ‘ä»¬çš„é‡å¤´æˆäº†,é›†ä¸­å¤„ç†å¤šç§èšåˆæ ‡ç­¾çš„ç‚¹å‡»äº‹ä»¶:
```
mAMap.setOnCameraChangeListener(new AMap.OnCameraChangeListener() {
                @Override
                public void onCameraChange(CameraPosition cameraPosition) {
                    //LatLng latLng = cameraPosition.target;
                    
                }

                @Override
                public void onCameraChangeFinish(CameraPosition cameraPosition) {

                    mClusterOverlay.updateClusters();//åˆ·æ–°
                    bClusterOverlay.updateClusters();
                }
            });
            
            
            mAMap.setOnMarkerClickListener(new AMap.OnMarkerClickListener() {
                @Override
                public boolean onMarkerClick(Marker marker) {
                    //mClusterOverlay.cleanListener();
                    Cluster cluster = (Cluster) marker.getObject();
                    if(cluster!=null && cluster.getClusterCount()>0){
                        if(cluster.getClusterItems().get(0).getUserType().equals("03")){
                            loge("æ˜¯æ™®é€šç”¨æˆ·èšåˆæ ‡ç­¾");
                            mClusterOverlay.respondClusterClickEvent(marker);//å“åº”èšåˆç‚¹çš„ç‚¹å‡»äº‹ä»¶    
                        }else {
                            loge("æ˜¯å•†å®¶ç”¨æˆ·èšåˆæ ‡ç­¾");
                            bClusterOverlay.respondClusterClickEvent(marker);//å“åº”èšåˆç‚¹çš„ç‚¹å‡»äº‹ä»¶
                        }
                    }
                    return true;
                }
            });
            
            ......
            
    //èšåˆæ ‡ç­¾çš„ç‚¹å‡»äº‹ä»¶
    @Override
    public void onClick(Marker marker, List<ClusterItem> clusterItems) {
        loge("ç‚¹å‡»äº†æ™®é€šç”¨æˆ·");
        
    }
    
    @Override
    public void onBClick(Marker marker, List<ClusterItem> clusterItems) {
        loge("ç‚¹å‡»äº†å•†å®¶ç”¨æˆ·");
        
    }

```
ä»£ç æœ‰ç‚¹å¤š,å…·ä½“ä¸šåŠ¡é€»è¾‘ä»£ç å°±ä¸è´´äº†,ä¼°è®¡çœ‹äº†ä¹Ÿä¼šæ¯”è¾ƒçš„çƒ¦,å¤§å®¶åªéœ€è¦çœ‹onMarkerClick()æ–¹æ³•ä¸­çš„é€»è¾‘å°±OKäº†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹,æˆ‘ä»¬éœ€è¦ç‚¹å‡»ä¸åŒçš„markerå,è·å–è¯¥markeråº”è¯¥å¯¹åº”çš„æ•°æ®,é‚£ä¹ˆè¯¥å¦‚ä½•è·å–å‘¢?ä¸ºäº†å¿«ç‚¹ç»“æŸæˆ˜æ–—,è¿™é‡Œæˆ‘å°±ä¸å–å…³å­äº†,é«˜å¾·markerç±»ä¸­æœ‰ä¸€æ–¹æ³•getObject(),å®˜æ–¹æ˜¯è¿™æ ·æè¿°çš„:

![è·å–markeré™„åŠ ä¿¡æ¯](http://upload-images.jianshu.io/upload_images/5256969-0d434a7340359c3f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

çœ‹åˆ°è¿™,å¾ˆå¤šäººä¸€å®šè±ç„¶å¼€æœ—,æ²¡é”™!è¿˜æœ‰ä¸ªå¯¹åº”çš„æ–¹æ³•marker.setObject(Object obj)ã€‚åœ¨ClusterOverlayä¸­,æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ä»£ç :
```
/**
     * å°†å•ä¸ªèšåˆå…ƒç´ æ·»åŠ è‡³åœ°å›¾æ˜¾ç¤º
     *
     * @param cluster
     */
    private void addSingleClusterToMap(Cluster cluster) {
        latlng1 = cluster.getCenterLatLng();
        markerOptions = new MarkerOptions();
        markerOptions
                .anchor(0.5f, 0.5f)
                .icon(getBitmapDes(cluster.getClusterCount()))
                .position(latlng1);
        Marker marker = mAMap.addMarker(markerOptions);
        marker.setAnimation(mADDAnimation);
        marker.setObject(cluster);
        marker.startAnimation();
        cluster.setMarker(marker);
        mcluster = cluster;
        mAddMarkers.add(marker);

    }
```
çœ‹çœ‹ä¸Šé¢è¿™å—ä»£ç ,æˆ‘ä»¬çš„ç¡®å‘ç°äº†marker.setObject(cluster)æ–¹æ³•,clusteré‡Œé¢æœ‰ä»€ä¹ˆ?æœ‰ClusterItemå‘€!çœ‹åˆ°è¿™,æˆ‘ä»¬å°±å‘ç°,å‰é¢çš„getUsertype()æ–¹æ³•ä¸æ˜¯æ­£å¥½æ´¾ä¸Šç”¨åœºäº†å˜›!æ·»åŠ èšåˆæ ‡ç­¾çš„æ—¶å€™,æˆ‘ä»¬ç»™æ¯ä¸ªmarkerè´´ä¸Šäº†"åç‰Œ",å½“æˆ‘ä»¬ç‚¹å‡»èšåˆæ ‡ç­¾çš„æ—¶å€™,æ‹¿åˆ°é™„åŠ çš„ä¿¡æ¯å¹¶æ‰¾åˆ°è¿™ä¸ªåç‰Œ(userType),è¿™æ ·ä¸å°±å¯ä»¥è½»è€Œæ˜“ä¸¾"æ’•æ‰åç‰Œ"äº†å—!ğŸ˜†

&emsp;&emsp;è¿™æ ·æˆ‘ä»¬å°±è§£å†³å¤šç§èšåˆæ ‡ç­¾ç‚¹å‡»å†²çªçš„é—®é¢˜äº†,è‡³äºå¦‚ä½•è§£å†³èšåˆæ ‡ç­¾ä¸æ™®é€šMarkerç‚¹å‡»äº‹ä»¶å†²çª,å…¶å®å¤§åŒå°å¼‚,è¿™é‡Œå°±ä¸çŒ®ä¸‘äº†,ç›¸ä¿¡å¯¹äºå¤§å®¶æ¥è¯´æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¸ºå¤§å®¶æä¾›markeråŠ è½½ç½‘ç»œå›¾ç‰‡çš„å®Œç¾è§£å†³æ–¹æ¡ˆ,è¯·æ‹­ç›®ä»¥å¾…!

&emsp;&emsp;æœ€å,å¤§å®¶æœ‰ä»»ä½•é—®é¢˜æˆ–è€…å»ºè®®,æ¬¢è¿ç•™è¨€æˆ–è€…åŠ ç¾¤è®¨è®º,è°¢è°¢.

ä»£ç åœ°å€ï¼š<https://github.com/Moosphan/AMapMarker-master>

![Androidé›†ä¸­è¥](http://upload-images.jianshu.io/upload_images/5256969-2bb978e570e25ebe.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

>ä¸ªäººåšå®¢ä¼ é€é—¨:www.moos.club